$.fn.locationPicker=function(e){var n=this,t=$.extend({address_el:'input[data-type="address"]',map_el:'[data-type="map"]',save_el:'[data-type="location-store"]',raw_data:!1,init:{current_location:!0}},e),a={},o=$(t.address_el),r=$(t.map_el),i=$(t.save_el),l=12,s=null,c="https://cdn0.iconfinder.com/data/icons/small-n-flat/24/678111-map-marker-128.png",d=function(){var e=new OpenLayers.Size(32,32),n=new OpenLayers.Pixel(-(e.w/2),-e.h),t=new OpenLayers.Icon(c,e,n);return t},g=d(),p=function(){var e=String.fromCharCode(65+Math.floor(26*Math.random())),n=e+Date.now();return n};this.clear=function(){a={},O.clearMarkers(),addressEl.val(""),u(),k()};var u=function(){i.length>0&&i.val(JSON.stringify(a))},f=function(e){var n={address:e.formatted_address,location:{lat:e.geometry.location.H,"long":e.geometry.location.L}};return t.raw_data&&(a.raw=e),n},L=function(e,n,t){void 0===t&&(t=!0);var a=new OpenLayers.LonLat(n,e).transform(new OpenLayers.Projection("EPSG:4326"),h.getProjectionObject());s=s?h.getZoom():l,t&&h.setCenter(a,s),m=new OpenLayers.Marker(a,g),O.clearMarkers(),O.addMarker(m)};OpenLayers.Control.Click=OpenLayers.Class(OpenLayers.Control,{defaultHandlerOptions:{single:!0,"double":!1,pixelTolerance:0,stopSingle:!1,stopDouble:!1},initialize:function(){this.handlerOptions=OpenLayers.Util.extend({},this.defaultHandlerOptions),OpenLayers.Control.prototype.initialize.apply(this,arguments),this.handler=new OpenLayers.Handler.Click(this,{click:this.trigger},this.handlerOptions)},trigger:function(e){var n=h.getLonLatFromPixel(e.xy).transform(h.getProjectionObject(),new OpenLayers.Projection("EPSG:4326"));a={location:{lat:n.lat,"long":n.lon}},geoCoder.geocode({location:new google.maps.LatLng(n.lat,n.lon)},function(e,n){"OK"==n&&(a=f(e[0])),L(a.location.lat,a.location.long,!1),k()})}});var y=r.attr("id");y||r.attr("id",p());var h=new OpenLayers.Map(r.attr("id"));h.addLayer(new OpenLayers.Layer.OSM);var O=new OpenLayers.Layer.Markers("Markers");h.addLayer(O);var v=new OpenLayers.Control.Click;h.addControl(v),v.activate();var m=null;geoCoder=new google.maps.Geocoder;var w=new google.maps.places.Autocomplete(o[0],{types:["geocode"]});google.maps.event.addListener(w,"place_changed",function(){place=w.getPlace(),a=f(place),L(a.location.lat,a.location.long),k()}),this.getData=function(){return a},this.getAddress=function(){return a.formatted_address};var C=function(e){geoCoder.geocode(e,function(e,n){"OK"==n&&e.length>0?(a=f(e[0]),L(a.location.lat,a.location.long),k()):clear()})};this.setAddress=function(e){C({address:e})},this.setLocation=function(e,n){C({location:new google.maps.LatLng(e,n)})};var _=function(){t.init&&(t.init.current_location?navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){L(e.coords.latitude,e.coords.longitude)},function(){L(49.8419505,24.0315968)}):t.init.address?n.setAddress(t.init.address):t.init.location&&n.setLocation(t.init.location))},k=function(){a.address&&o.val(a.address),u(),t.locationChanged&&t.locationChanged(a)};return _(),this};